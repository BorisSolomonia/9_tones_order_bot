import logging
import os
import re
from datetime import datetime
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes
from rapidfuzz import process
import openai
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import asyncio

# --- SETUP ---

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)

TELEGRAM_TOKEN = "TELEGRAM_BOT_KEY"
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
GOOGLE_CREDENTIALS_FILE = "google-credentials.json"
SPREADSHEET_NAME = "9tones_orders"

openai.api_key = OPENAI_API_KEY

# Known product and customer lists
KNOWN_PRODUCTS = [
    "მცენარეული ცხიმი",    "მაიონეზი",    "ქათმის ნაგეთსი",    "კარტოფილი ფრი",    "ფიტურნიის ცხიმი",    "პირობითი პროდუქტი",    "ქათმის ფილე",    "თევზი სიომგა",    "პანგასიუსის ფილე",    "ქათმის მკერდი",    "მზესუმზირის ზეთი",
    "ღორის ბარკალი",    "ორაგულის ფილე",    "სკუმბრია",    "საქონლის ხორცი",    "საქონლის ბარამანსა",    "ძროხის ხორცი",    "თევზი ხეკი",    "ქათამი",    "ქათმის ბარკალი",    "ქათმის კროკეტი",    "ქათმის კუჭი",    "ქათმის ფრთა",    "ქათმის ღვიძლი",    "ღორის სუკი",    "ღორის კისერი",    "ღორის ჩალაღაჯი",    "ღორის ნეკნი",    "ფრიტურის ზეთი",    "მექსიკური კარტოფილი",    "ორაგული",    "კეტჩუპი",    "ქათმის ინერფილე",    "საქონლის ხორცის სტეიკი",    "თხევადი აირი", "ღორის ხორცი", "პიცის ყველი",    "თევზი ტილაპიის ფილე",    "ქათმის ფარში",    "ღორის კანჭი",    "კარტოფილი",    "ღორის ბეჭი",    "ბუნებრივი აირი",    "თვითწებვადი ლენტა",    "სტრეჩი", "ავტონაწილები", "თევზი ორაგული", "დიზელი","ხორცის დაჭრის მომსახურება"
]

KNOWN_CUSTOMERS = [
    "თეისთი", "ფუდსელი", "დიღომი ჰუდი", "ნინო მუშკუდიანი", "ზემელი", 
    "გიორგი რაზმაძე", "უკვე", "იომ იომ", "საბურთალო მენეჯმენტი", "გულიანი", 
    "ფუდ-ჰარტი", "ხატია ჭითანავა", "წისქვილი ჯგუფი", "ბიგ სემი", "ბექა გილიგაშვილი", 
    "რესტორან ჯგუფი", "სამიკიტნო-მაჭახელა", "დე მედ შეფი", "თაღლაურა მენეჯმენტ კომპანი", 
    "ელსი კატერინგი", "ინა აივაზოვა", "ეს.ქეი. სამზარეულო", "ვრაპ მასტერი", "წიწილა გრუპ", 
    "ქუალითი ფუდს", "აბერინტ", "ჯეოფიტმენი", "ევროპული სკოლა", "გენაცვალე ფუდ დელივერი", 
    "მაგსი", "სპექტრა", "ფასანაური", "პრემიუმ სენდვიჩი", "ნიტრო", "ფუდ ენდ ვაინ", "ბადრი ჯურხაძე", 
    "გიორგი", "სიმბა", "ირაო +", "რიჩ9", "ქეი.ემ", "გიორგი არაბიძე", "სანდრო", "ვარლამ ცაგურია", 
    "დიდებული", "გლდანი მენეჯმენტი", "ვარკეთილი მენეჯმენტი", "ბაფფალოს", "ვერიკო ქურიძე", 
    "სულხან თვალჭრელიძე", "ტამტამ", "ვინი", "სთრით ფუდი", "სანდრო ჩილაძე", "სანჩო19", 
    "კანტინერია", "ირმა შარაშიძე", "მედვენთა", "ლავა შაურმა", "ძაძიკი", "ბურგერ სფეისი", "ტოპ ზე შეიკერ", 
    "მარინე კილაძე", "სუში მანია", "კომანდოსი", "ფრიზი ჯორჯია", "გლოვ შაურმა", "თამარი ღვინაშვილი", 
    "ბი ბაქ", "ფლოვ", "ომეხი ჩხაპელია", "კონსტრაქშენ სერვაის", "თავადური", "პლაზა მენეჯმენტი", 
    "ტიფლის ფაბ", "კობა ძიძიგური", "სორტე ჰარაქათ", "ოჯახური სამზარეულო ქართული გემო", "თეისთ", 
    "დასავლეთ ევროპისა და იაპონიის სურსათი დის", "ვარაზის ხევი 95", "კუში ინდიან ფუდ", 
    "აკაკი დეკანოსიძე", "რკ რესთორანთ", "ვ.დ. დისტრიბუცია", "გემო", "რამინი გამგებელი", "ანი-პონჩო", 
    "შნო მოლი", "საჭე-92", "ქეთო ხვისტანი", "აკვავიტე", "ნეკაფე", "ლაშა ბარამიძე", "ჰაფსა მოტორს", 
    "ტაი-ტაი", "დინარა შავერდოვა", "სტარ+", "ანნა უშიკიშვილი", "ფუდ გუდი", "კოპალა 3", 
    "ელენა ბოგვერაძე", "ლუდი", "გალაქტიკა 5", "კით კლუბი", "ვახტანგ ათაბეგაშვილი", "პიანო", 
    "მაქსი ლენდი", "ბეიქერი ფუმფულა", "ილია ხიპაშვილი", "სქაი", "კახაბერ კიკორია", "არტკაფე 1", 
    "მაია ხვისტანი", "აკიდო", "ივანე კეღოშვილი", "სახლი ვერაზე", "დავით ცარციძე", "მს ჯგუფი", 
    "ეპოქა 2000", "ბიგ შაურმა", "ფიესტა ბარი", "მალხაზ ტეტუნაშვილი", "ბუკა", "ნინო ლომიძე", 
    "ბაჩუკი უშხვანი", "გოდერძი ჯაბანაშვილი", "ქალაქი 27", "თერთმეტი", "ნინო კიკნაძე", "ბუდვაიზერი - სამსონი", 
    "სტილი", "ვალენტინო ჯორჯია", "რაჭა", "ბურგერების სამინისტრო", "გრინ თაუერი", "კუში ფუდი", 
    "ბურგერის დროა", "გულნარა გუგენიშვილი", "სვეტლანა გრიგორიან", "მელიტა ჩანკიანი", "ჩვენი", 
    "გლობალ სერვისიზ ოფ ჯორჯია", "სტრიჩა", "ერთი ნაბიჯი 20", "გიორგი ბახტაძე", "ნათია ვარამაშვილი", "ბელვიუ ბუტიკ", 
    "ქასიმია ვარდ", "მარიანა კორახაშვილი", "თალალო", "გლოუ დონერ", "ხათუნა ფოლადიშვილი", 
    "რამაზ ტეტუნაშვილი", "იოკო აზია", "ბაქსვუდის საერთაშორისო სკოლა - თბილისი", "ბაქსვუდის სკოლა გელოვანზე", 
    "ფატიმა მურცხვალაძე", "ნინო ხაჭაპურიძე", "ბუფეტი ლისზე", "ბექა ნარიმანიძე", "მეგა", 
    "არჩილი შუბითიძე", "მადლენა ნიჟარაძე", "პიანსე", "მზევინარი ყირიმლიშვილი", "ფუდ სერვისი", 
    "ლეგ-კულინარი 4", "ნანა კაკაბაძე", "სიღარიბის დაძლევა და გადაუდებელი დახმარება დავით კინწურაშვილის საქველმოქმედო ფონდი მომავლის გზა", 
    "ჯაბა ვადაჭკორია", "ორიგინალი", "გაიოზ გაგნიძე", "ჩურჩუტელა", "მასპინძელო", 
    "ფლეურს საქართველო", "თამარ მიქაბერიძე", "თეა არჯევანიძე", "ბონანნო პლიუსი", 
    "ვლადიმერ ტარიელაშვილი", "შეფი", "იმერული ეზო ნატახტარში", "ალექსანდრე მელია", "ბაგები", 
    "ღვინის ისტორია", "ფრეშსფერო", "ალფა ფუდი", "ლევან ოგანეზოვი", "კენკო", "ფა-ლა-ფელ-2", 
    "გიროგრილ.ჯი", "თამარ ჩერქეზიშვილი", "ცენტრალ პაბ", "თამარა არაბიძე", "ტრედა", "ხინკლის ფაბრიკა", 
    "ათუ", "ნიკა კვირიკაძე", "ისთ2ა", "დე.დე.ან.", "რესტორან მენეჯმენტ კომპანი", "დარეჯანი გლურჯიძე", 
    "ვლადიმერ მდივნიშვილი", "ნათია ლაფერიშვილი", "ალექსი მღვდლიშვილი", "კობა როსტიაშვილი", 
    "ლევან სააკიანი", "ცაბუნია ღვინაშვილი-მაჩხაშვილი", "კესო კერატიშვილი", "გიორგი ერბოწონაშვილი", 
    "ნანა რუაძე", "გიორგი ბაირამაშვილი", "მარკეტ", "მაკა შეყლაშვილი", "სრი ბალაჯი ენთერფრაისის", 
    "ელენე ჩხიკვიშვილი", "გიორგი შალვაშვილი", "ვასილი შარმიაშვილი", "დავით ქუფარაშვილი", 
    "იზოლდი ტურიაშვილი", "ნუნუ ბერიძე", "ბარაქა 21", "თამარ კაკულია", "შაურმა ფექთორი", "აუგუსტ ბეიქერი", "ვაინგრუპი", 
    "ირაკლი გერლიანი", "გივი გივიშვილი", "გრიქ ფოინთ", "სოფიო გუნიავა", "ნელი ნარიმანიძე", 
    "რვა ტონა", "ნათია კოკჩე", "ნამდვილი გემო", "შეფი ბორბლებზე", "კრაფტ ფუდ რესტორნები", 
    "ეკა ქურდიანი", "ბახტრიონი", "შაურმიკო", "გიორგი წიქარიძე", "ლეონარტგან", "ანისალ ჯორჯია", 
    "შორენა ნაჭყებია", "ბბ", "შაურმა ჰაბი", "გიორგი სადაღაშვილი", "ჯასთ ჰაბი", "გარიკ ხლხატიანი", 
    "მარი ზურიაშვილი", "ვეგანბაო", "ბაბლი 76", "ნიკა მეტრეველი", "ლიბერთი ბიზნეს ემპაიარი", 
    "ტაიფუდი", "საოჯახო სამზარეულო მეგაფუდი", "მიქსი", "ბრინკს", "მადლიანი", "ნინია", "თხილი", 
    "ნანა გიორგაძე", "ოპინიონ", "მიხეილი ჩხენკელი", "ინგა გოროზია", "დენსინგ დრიმერსი", 
    "ქეთევან ბუიშვილი", "იმერეთი ფუდი", "ირაკლი გოგელია", "ქოფიშოპ ჯორჯია", "ბექა ხითარიშვილი", 
    "აუგუსტი", "დაიზენ", "ლელა სიგუა", "საქართველოს ფერმერთა სადისტრიბუციო კომპანია", 
    "ვადიმ აივაზოვი", "ნოსტალგია", "აუგუსტ რითეილი", "ნანა", "ფრეშ დისტრიბუცია", "მზარეული", 
    "ზე სტეიშიონ ლიბანის", "შაჰრუზა", "სოლომონი კობერიძე", "ნოდარ მთავრიშვილი", "დავით თუშიშვილი", 
    "მარინე ხვედელიძე", "მერაბი ბერიშვილი", "ხვიჩა მაზანაშვილი", "მიმი", "ვანიკო შერმადინი", "გუდ", 
    "ცირა სიხარულიძე", "ქორები", "ალექსანდრე ჯორჯიკია", "აგატა გოგიშვილი", "თეისთ ოფ ინდია", 
    "ზურაბ ძიძიგური", "იაკობი", "სოუ ლაქი", "თეა გუნიავა", "ლევანი გოგიჩაშვილი", "როიალ გრუპ", 
    "ენთი გრუპ ჯორჯია", "სერვის თრასთი", "რუსუდან რაზმაძე", "აკდისტრიბუცია", "კეინ ნოლან", 
    "ნავი გრუპი", "სანაპირო", "გეობესთი", "ბელიაშვილი", "ინგა სოხაძე", "დუმფარა", "ბექა ჯმუხაძე", 
    "გეოდინერი", "ციცი მიქელაძე", "ლალი ნავროზაშვილი", "ნინო წულაძე", "ანო", "პავან სინგჰ", 
    "ნიუ თეისთი", "მაია ლაცაბიძე", "მაგემე", "მაკ ენდ ჩიზი კომპანია", "მადლენა კვაშილავა", "მოლი მისაქ",
    "სოფიო ბასილაშვილი", "სმეში", "ანზორ შერმადინი", "გელა კომლაძე", "კონსტანტინე ქიტიაშვილი", 
    "რესტორანი იბერიკა", "სამთა ტკბილისი", "ლალი აბრამია", "ამანე ორბელიანი", "ბრუკლინ ბურგერი", 
    "ვიკა", "პიტა-ფრეში", "ჩიბუსი", "სურსათი 1", "სვეტლანა სოხანეიშვილი", "სვით ჰაბი", 
    "მწვადის შაურმა", "ციური ვაშაკიძე", "მამუკა კუპატაძე", "გურმანი", "ჰანგრიმენი", "ჯორჯია ოვერ სიიზ", 
    "მე მინიონები", "ფუდ კონცეპტი", "ზედაზენი", "კახაბერ კერესელიძე", "სალომე მანდარია", 
    "ასმათი შელია", "გოგი სიდამონიძე", "თამარი მაისურაძე", "მაკ & ჩიზი", "ფუკეტი ტაილანდური კაფე და სამზარეულო", 
    "მწერლები", "მირანდა ჯიმშელეიშვილი", "ლისის ბუფეტი", "ლანჩრუმ", "მეჯიქ სოუსი", 
    "ტაი ინდი ჯგუფი", "შაურმის სახლი", "მაგდა ბოგვერაძე", "ნოდარი ხეცაძე", "ლუდსახარში ორი კათხა", 
    "ვახტანგ იასაღაშვილი", "რაჭული კერია", "პინო ვერა", "ლბ ტრეიდინგ", "ბენტო", "ფალაფელ სთორიზ", 
    "ტაი თბილისი", "პალერმო", "ლიზიკო ფიფია", "გემრიელი1", "ზურაბ როსტიაშვილი", "სარანტინო", 
    "ევგენიი პოდოსენოვ", "ეკა ვაჭარაძე ხაჩიძე", "მს გლდანი", "ოლეკსეი კლიჩ", "რომან ვასილევ", 
    "თეა ხმიადაშვილი", "რობერტ კარაპეტიანი", "სვეტლანა რაზმაძე", "გრინ ფუდი", "ემ პლიუს გრუპი", 
    "თორნიკე ოსაძე", "იმედა ხოხიაშვილი", "ნატალია დელიბაშვილი", "კარპე ჩაგელიშვილი", "რესტო ლინკს",
    "ჯაფე ბარი აუდიტორია", "პალას გრუპ", "ფალას ქითჩენ", "პკ ლუბლიანა", "დიზაინ ჰოთელ", 
    "იზიდრაივი", "სქულფუდ", "ქეთი და ლივიას კომპანია", "ფუდაჰოლიკ", "ბაკური ბარბაქაძე", 
    "ალექსანდრე გოგსაძე", "ლიმონჩიკი", "პეკინის სასტუმრო", "სთარ ბოის", "კვების სახლი მაისურაძე", 
    "ვებერი პერელ", "სევენ.ჯ", "ქართულ-ამერიკული სკოლა", "მოსე ჯეო", "კუმარ ინდიან კაფე", 
    "ფიროსმანის დუქანი", "ენჰაიტ +", "ჯაპანჯორჯია", "მალხაზ ღვინიანიძე", "მარიამ გოგოლაური", 
    "დამოუკიდებელი სკოლა მოძღვარი", "ირმა წიკლაური", "კარმიანი", "ნათია მერებაშვილი", "კატოსან", 
    "ამბიცია", "ნატახტარი 1717", "რჯ 22", "ხვიჩა ფუტკარაძე", "საბა", "მასურო", "ალექსანდრე ხერხეულიძე",
    "ვიაიპი", "აბუ თი შოპ ჯი", "ალეკო ქისიშვილი", "აზია ფუდ ფროდაქშენ", "მწვანე კრეატივი", 
    "მსუყე", "მსრ", "რ ნ ა ენთერფრაისის", "A.M.D", "კანჭი +", "ოცდაცამეტი 33", "ეს ემ ენ 24", 
    "გურამ მამულია", "ვახტანგური", "ბეღელი საოჯახო სამზარეულო", "ევრაზიის კომპანია", "გურმე", 
    "რობერტ მელიკიანი", "ჩინებული გემო", "გაგა გუცხრიკიძე", "გიორგი პეტრიაშვილი", "ნიკა სადაღაშვილი", "ახალი ჯგუფი", "ვისტა ვორქს", "ალ მალაკ 1", "მიხეილ გვენეტაძე", "გბნ1 გრუპი", "ჩიკიტა", "თეონა თორია", "ჰანგრი დაინ", "კოკა777", "გასტრო ფაქტორი", "ვალენტინ პანკოვ", "გესთი", "ლუტიძე ნოდარ", "ნანული წიქარიშვიკი", "რომან კონოვალოვ", "ალბინა ხუდოიან", "ანადოლუ სოფრასი"
]

scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds = ServiceAccountCredentials.from_json_keyfile_name(GOOGLE_CREDENTIALS_FILE, scope)
client = gspread.authorize(creds)
sheet = client.open(SPREADSHEET_NAME).sheet1

# --- FUNCTIONS ---

def fuzzy_match(term, known_list, threshold=80):
    match, score, _ = process.extractOne(term, known_list)
    return match if score >= threshold else None

def extract_data_from_line(line):
    line = line.strip()
    # Format: Customer. Product Quantity Comment (optional)
    match = re.match(r"(.+?)\s*\.\s*(.+?)\s+(\d+)(კგ|ც)?\s*(.*)?", line)
    if not match:
        return None

    customer_raw, product_raw, number, unit, comment = match.groups()
    customer = fuzzy_match(customer_raw, KNOWN_CUSTOMERS)
    product = fuzzy_match(product_raw, KNOWN_PRODUCTS)
    amount = f"{number} {unit}".strip() if number else ""

    if customer and product:
        return {
            "type": "order",
            "customer": customer,
            "product": product,
            "amount": amount,
            "comment": comment or ""
        }
    return call_gpt_for_parsing(line)

def call_gpt_for_parsing(text):
    prompt = f"""
    The following text is a Georgian order message. Extract and return the customer name, product name, quantity, and optional comment.
    Text: "{text}"
    Return JSON like: {{"type": "order", "customer": "ჟღენტი", "product": "პერედინა", "amount": "30კგ", "comment": ""}}
    """

    response = openai.ChatCompletion.create(
        model="gpt-4o",
        messages=[
            {"role": "system", "content": "You are a helpful assistant that extracts structured Georgian order data."},
            {"role": "user", "content": prompt}
        ]
    )
    try:
        parsed = eval(response['choices'][0]['message']['content'])
        return parsed
    except Exception as e:
        logging.error(f"GPT parsing failed: {e}")
        return None

def update_google_sheet(data, author):
    if data['type'] == 'order':
        date_str = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        sheet.append_row([date_str, data['customer'], data['product'], data['amount'], data['comment'], author])

# --- TELEGRAM HANDLERS ---

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("Welcome! Send me an order message and I will log it to Google Sheets.")

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    author = update.message.from_user.full_name or update.message.from_user.username or str(update.message.from_user.id)
    lines = text.split('\n')
    for line in lines:
        # Handle multiple orders in one line, split by ; or ,
        for subline in re.split(r'[;,]', line):
            subline = subline.strip()
            if subline:
                data = extract_data_from_line(subline)
                if data:
                    update_google_sheet(data, author)
                    await update.message.reply_text(f"✅ Logged: {data}")
                else:
                    await update.message.reply_text(f"❌ Couldn't understand: {subline}")

# --- MAIN ---

def main():
    app = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.run_polling()

if __name__ == "__main__":
    main()

